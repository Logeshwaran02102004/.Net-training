--  customers table
create table customers (
    custid int primary key,
    custname varchar(100),
    email varchar(150),
    city varchar(100)
);
insert into customers ( custid, custname, email, city) values
(1, 'Amit Sharma', 'amit.sharma@gmail.com', 'Mumbai'),
(2, 'Ravi Kumar', 'ravi.kumar@yahoo.com', 'Delhi'),
(3, 'Priya Singh', 'priya.singh@gmail.com', 'Pune'),
(4, 'John Mathew', 'john.mathew@hotmail.com', 'Bangalore'),
(5, 'Sara Thomas', 'sara.thomas@gmail.com', 'Kochi'),
(6, 'Nidhi Jain', 'nidhi.jain@gmail.com', NULL);
select * from customers


-- products table
create table products (
    productid int primary key,
    productname varchar(150) ,
    price decimal(10,2) ,
    stock int 
);

insert into Products (productid, productname, price, stock) values
(101, 'Laptop Pro 14', 75000, 15),
(102, 'Laptop Air 13', 55000, 8),
(103, 'Wireless Mouse', 800, 50),
(104, 'Mechanical Keyboard', 3000, 20),
(105, 'USB-C Charger', 1200, 5),
(106, '27-inch Monitor', 18000, 10),
(107, 'Pen Drive 64GB', 600, 80);

select * from products

-- Table orders
create table orders (
    orderid int primary key,
    custid int,
    orderdate date ,
    status varchar(50),
    foreign key (custid) references customers(custid)
);

insert orders (orderid, custid, orderdate, status) values
(5001, 1, '2025-01-05', 'Pending'),
(5002, 2, '2025-01-10', 'Completed'),
(5003, 1, '2025-01-20', 'Completed'),
(5004, 3, '2025-02-01', 'Pending'),
(5005, 4, '2025-02-15', 'Completed'),
(5006, 5, '2025-02-18', 'Pending');
select * from orders

-- order deatails
create table orderdetails (
    detailid int primary key,
    orderid int,
    productid int,
    qty int ,
    foreign key (orderid) references orders(orderid),
    foreign key (productid) references products(productid)
);

insert into orderdetails (detailid, orderid, productid, qty) values
(9001, 5001, 101, 1),
(9002, 5001, 103, 2),
(9003, 5002, 104, 1),
(9004, 5002, 103, 1),
(9005, 5003, 102, 1),
(9006, 5003, 105, 1),
(9007, 5003, 103, 3),
(9009, 5005, 107, 4),
(9010, 5005, 104, 1),
(9011, 5006, 101, 1),
(9012, 5006, 107, 2);
select * from orderdetails

-- payments table
create table payments (
    paymentid int primary key,
    orderid int,
    amount decimal(10,2),
    paymentdate date,
    foreign key (orderid) references orders(orderid)
);

insert into payments (paymentid, orderid, amount, paymentdate) values
(7001, 5002, 3300, '2025-01-11'),
(7002, 5003, 62000, '2025-01-22'),
(7003, 5005, 4500, '2025-02-16');
select * from payments


-- placing an order in last 30 days

select c.custid, c.custname, c.email, c.city, d.orderid, d.orderdate
from customers c
join orders d on c.custid = d.custid
where d.orderdate >= dateadd(day, -30, getdate());

--top 3 product & highest sales amount
select top 3 c.productid,c.productname,sum(d.qty*c.price) as TotalSales
from products c
join orderdetails d on c.productid = d.productid
join orders o on d.orderid =o.orderid
group by c.productid, c.productname
order by TotalSales desc


-- for each city showing the customer count and order count
select c.city, count(distinct c.custid) as custcount, count(o.orderid) as ordcount
from customers c
left join orders o
on c.custid = o.custid
group by c.city;


-- retrive the order id if they order more than two product
select c.orderid
from orderdetails c
group by c.orderid
having count(distinct c.productid) > 2;


--to check order amount greater than 10000 
select c.orderid,sum(c.qty * d.price) as TotalAmount
from orderdetails c
join products d
on c.productid=d.productid
group by c.orderid
having sum(c.qty*d.price)>10000;


-- customer order same product more than once
select c.custid, c.custname from customers c
join orders d
on c.custid=d.custid
join orderdetails e
on d.orderid=e.orderid
group by c.custid,c.custname, e.productid
having count(*)> 1;


-- employee wise order deatails
select c.custid as EmpID,count(c.orderid) as TotalOrders,
min(c.orderdate) as firstdate,max(c.orderdate) as lastdate
from orders c group by c.custid

-- view vw_lowstockproducts
alter view dbo.vw_LowStockProducts
with schemabinding, encryption
as
select productid, productname, price, stock
from dbo.products
where stock < 10;
go
select * from dbo.vw_LowStockProducts;

-- table valued function

alter function dbo.fncustomerorderhistory(@customerid int)
returns @tempordertable table
( orderid int,orderdate date,totalamount decimal(18,2))
as begin
insert into @tempordertable (orderid, orderdate, totalamount)
select o.orderid,o.orderdate,sum(od.qty * p.price) as totalamount from orders o inner join 
orderdetails od on o.orderid = od.orderid inner join products p on od.productid = p.productid
where o.custid = @customerid group by o.orderid, o.orderdate;
return
end
select * from dbo.fncustomerorderhistory(1)

--2 function

alter function dbo.fngetcustomerlevel(@CustID int)
returns varchar(20)
as begin
declare @totalpurchase decimal(10,2)
declare @customerlvl varchar(20)
select @totalpurchase = sum(ods.Qty*p.price) from orders o inner join orderdetails ods
inner join products p on ods.productid = p.productid on o.custid = @custid
if @totalpurchase >100000
set @customerlvl = 'Platinum'
else if @totalpurchase >= 50000 and @totalpurchase <=100000
set @customerlvl = 'Gold'
else 
set @customerlvl = 'Silver'
return @customerlvl
end
 
select dbo.fngetcustomerlevel(1) AS CustomerLevel;
 



--procedures to update product price 

create procedure sp_updateproductprice
@productid int,
@newprice decimal(10,2)
as
begin
set nocount on;
if (@newprice <= 0)
begin
throw 50001, 'price must greater than 0.',1;
end;
if not exists(select 1 from products where productid=@productid)
begin
throw 50002, 'product does not exist.', 1;
end;
declare @oldprice decimal(10,2);
select @oldprice =price from products where productid = @productid;
insert into pricehistory (productid, oldprice) values (@productid, @oldprice);
update products set price =@newprice where productid = @productid;
print 'price updated successfully.';
end;

-- procedure to seach orders

create procedure sp_SearchOrders_v3
@CustName varchar(100) = null,
@CustCity varchar(100) = null,
@ProdName varchar(100) = null,
@FromDate date = null,
@ToDate date = null
as
begin
    select 
        oRdr.orderid,
        oRdr.orderdate,
        oRdr.status,
        cst.custname,
        cst.city,
        prd.productname,
        odtl.qty,
        (odtl.qty * prd.price) as ItemTotal
    from orders oRdr
    inner join customers cst on oRdr.custid = cst.custid
    inner join orderdetails odtl on oRdr.orderid = odtl.orderid
    inner join products prd on odtl.productid = prd.productid
    where (@CustName is null or cst.custname like '%' + @CustName + '%')
      and (@CustCity is null or cst.city = @CustCity)
      and (@ProdName is null or prd.productname like '%' + @ProdName + '%')
      and (@FromDate is null or oRdr.orderdate >= @FromDate)
      and (@ToDate is null or oRdr.orderdate <= @ToDate);
end;


--select * from products
--select * from orders
--select * from customers

-- triggers 1 create a trigger on products
alter trigger preventproductdeletion
on products
instead of delete
as
begin
if exists(
select 1 from deleted d
inner join orderdetails od on d.productid = od.productid
)
begin
throw 50003, 'Cannot delete the product which is already existing in the order details', 1;
return;
end
 
delete from products where productid in (select productid from deleted);
end;
 

-- triggers 2 create After update 

alter trigger Afterupdate
on payments after update
as
begin
insert into paymentaudit(PaymentID, OldAmount, NewAmount)
select d.PaymentID, d.Amount as oldamount,i.Amount as newamount
from deleted d
join inserted i on d.PaymentID = i.PaymentID;
end;
 
update Payments set Amount = 1500
where PaymentID = 7001;
 
select * from  paymentaudit


-- trigger 3 Create an instead of delete trigger 

create trigger insteadofdeletecustomer
on customers
instead of delete
as
begin
update customers
set custname = 'Inactive',
email = null,
city = null
where custid in (
select d.custid from deleted d
where exists (select 1 from orders o where o.custid = d.custid)
);
 
delete from customers
where custid in (
select d.custid from deleted d
where not exists (select 1 from orders o where o.custid = d.custid)
);
end;


--select * from customers










